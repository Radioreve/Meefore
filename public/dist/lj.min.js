/*
 Vodksy 2015-01-08 
*/
function sleep(a,b,c){setTimeout(function(){b(c)},a)}function look(a){return JSON.stringify(a,null,"	")}window.LJ=_.merge(window.LJ||{},{params:{socket:null,domain:"http://87.247.105.70:1337"},ui:{artificialDelay:600,displayIn:{opacity:[1,0],translateX:[-8,0]},displayOut:{opacity:[0,1],translateX:[10,0]}},cloudinary:{uploadParams:{cloud_name:"radioreve",api_key:"835413516756943"},displayParamsProfile:{cloud_name:"radioreve",width:150,height:150,crop:"fill",gravity:"face"},displayParamsEventHost:{cloud_name:"radioreve",width:80,height:80,crop:"fill",gravity:"face",radius:"2"},displayParamsEventAsker:{cloud_name:"radioreve",width:45,height:45,crop:"fill",gravity:"face",radius:"0"},displayParamsHeaderUser:{cloud_name:"radioreve",width:50,height:50,crop:"fill",gravity:"face",radius:"max"},displayParamsOverlayUser:{cloud_name:"radioreve",width:280,height:280,crop:"fill",gravity:"face",radius:"max"},displayParamsAskerMain:{cloud_name:"radioreve",width:120,height:120,crop:"fill",gravity:"face",radius:3},displayParamsAskerThumb:{cloud_name:"radioreve",width:45,height:45,crop:"fill",gravity:"face",radius:"max"},displayParamsAskerThumbRefused:{cloud_name:"radioreve",width:45,height:45,crop:"fill",effect:"grayscale",gravity:"face",radius:"max"},loader_id:"ajax-loader-black_frpjdb",m_loader_id:"ajak_lgmgym",displayParamsLoader:{cloud_name:"radioreve",html:{"class":"loader"}},placeholder_id:"placeholder_jmr9zq",displayParamsPlaceholder:{cloud_name:"radioreve",html:{"class":"mainPicture"},width:150}},user:{},myEvents:[],myAskers:[],myUsers:[],myFriends:[],selectedTags:[],selectedLocations:[],$eventsToDisplay:$(),nextCallback:{},state:{connected:!1,fetchingEvents:!1,fetchingAskers:!1,animatingContent:!1,animatingChat:!1,toastAdded:!1,jspAPI:{}},tpl:{toastInfo:'<div class="toast toastInfo" class="none"><span class="toast-icon icon icon-right-open-big"></span><span class="toastMsg"></span></div>',toastError:'<div class="toast toastError" class="none"><span class="toast-icon icon icon-cancel"></span><span class="toastMsg"></span></div>',toastSuccess:'<div class="toast toastSuccess" class="none"><span class="toast-icon icon icon-right-open-big"></span><span class="toastMsg"></span></div>',noResult:'<center id="noEvents" class="filtered"><h3>Aucun évènement pour ce choix de filtre </h3></center>',charte:'<div id="charte" class="centered"> 					<h2>Charte d\'engagement V&W </h2> 					<div class="subcharte"><span>1</span> Ne jamais se présenter à un event les mains vides </div> 					<div class="subcharte"><span>2</span> Toujours respecter les autres utilisateurs </div> 					<div class="subcharte"><span>3</span> Parler de V&W à vos amis </div> 					<div class="charte-accept">Accepter</div> 					<div class="charte-accept">"Refuser"</div> 				 </div>'},tagList:[],locList:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20],$body:$("body"),$loginWrap:$("#loginWrapp"),$signupWrap:$("#signupWrapp"),$resetWrap:$("#resetWrapp"),$profileWrap:$("#profileWrap"),$eventsWrap:$("#eventsWrap"),$manageEventsWrap:$("#manageEventsWrap"),$askersListWrap:$("#askersListWrap"),$thumbWrap:$("#thumbWrap"),$loginBtn:$("#login"),$signupBtn:$("#signup"),$resetBtn:$("#reset"),$emailInput:$("#email"),$passwordInput:$("#pw"),$lostPassword:$("#lost_pw"),$emailInputSignup:$("#emailSignup"),$passwordInputSignup:$("#pwSignup"),$passwordCheckInput:$("#pwCheckSignup"),$backToLogin:$("#b_to_login"),$validateBtn:$("#validate"),$locationInput:$("#location"),$loaderWrap:$(".loaderWrap"),$createEventWrap:$("#createEventWrap"),$createEventBtn:$("#createEventBtn"),$contentWrap:$("#contentWrap"),$contactWrap:$("#contactWrap"),$menuWrap:$("#menuWrap"),$eventsListWrap:$("#eventsListWrap"),$logout:$("#logout")}),window.LJ.fn=_.merge(window.LJ.fn||{},{renderEvents:function(a,b){var c="";if(b=b||a.length,0==b)return'<h3 id="noEvents">Aucun évènement à afficher pour le moment.</h3>';for(var d=0;b>d;d++)c+=LJ.fn.renderEvent(a[d]);return c},renderAskersMain:function(a,b){for(var c="",a=LJ.myAskers,b=b||a.length,d=0;b>d;d++)b>d&&(c+=0==d?LJ.fn.renderAskerMain(a[d],"active"):LJ.fn.renderAskerMain(a[d]));return c},renderChatWrap:function(a){return'<div class="chatWrap chat-asker none" data-chatid="'+a+'"><div class="chatLineWrap"></div><div class="chatInputWrap"><input type="text" value="" placeholder="Can I come with my friends ?"><input type="submit" value=""></div></div>'},renderEventTags:function(a){for(var b='<div class="tag-row">',c=a.length,d=0;c>d;d++)b+='<div class="tag tag-'+a[d]+'">'+LJ.fn.matchTagName(a[d])+"</div>";return b+="</div>"},renderEventButton:function(a,b){return b==LJ.user._id?'<div class="askInWrap"><button class="themeBtnToggle themeBtnToggleHost">Management</button></div>':LJ.user.eventsAskedList.indexOf(a)>-1?'<div class="askInWrap">                           <button class="themeBtnToggle askIn asked"> En attente </button>                            <div class="chatIconWrap"><i class="icon icon-chat"/></div>                           <div class="friendAddIconWrap"><i class="icon icon-user-add"/></div>                        </div>':'<div class="askInWrap">                           <button class="themeBtnToggle askIn idle"> Je veux y aller </button>                            <div class="chatIconWrap none"><i class="icon icon-chat"/></div>                           <div class="friendAddIconWrap none"><i class="icon icon-user-add"/></div>                        </div>'},renderHostImg:function(a,b){var c=LJ.cloudinary.displayParamsEventHost;c.version=b;var d=$.cloudinary.image(a,c).addClass("zoomable").attr("data-imgid",a).attr("data-imgversion",b),e=d.prop("outerHTML");return e},renderAskerInEvent:function(a,b){var c=$.cloudinary.image(a,LJ.cloudinary.displayParamsEventAsker);if(c.attr("data-imgid",a).addClass("zoomable"),b&&b.dataList.length>0)for(var d=0;d<b.dataList.length;d++)c.attr("data-"+b.dataList[d].dataName,b.dataList[d].dataValue);return c},renderAskersInEvent:function(a){var b=a.length,c="";for(i=0;i<b;i++){var d={classList:["hello"],dataList:[]},e=LJ.cloudinary.displayParamsEventAsker;if(i<b){var f=a[i].imgId;e.imgVersion=a[i].imgVersion,d.classList=["askedInThumb"],d.dataList=[{dataName:"askerid",dataValue:a[i]._id}]}c+=LJ.fn.renderAskerInEvent(f,d).prop("outerHTML")}return c},renderEvent:function(a){var b=a._id,c=a.hostId,d=a.hostImgId,e=a.hostImgVersion,f=a.tags,g=LJ.fn.buildChatId(b,c,LJ.user._id),h=LJ.fn.renderHostImg(d,e),i=LJ.fn.renderEventButton(a._id,c),j=LJ.fn.renderEventTags(f),k=LJ.fn.renderChatWrap(g),l=LJ.fn.renderAskersInEvent(a.askersList,a.maxGuest),m='<div class="eventItemWrap" data-eventid="'+a._id+'" data-hostid="'+a.hostId+'" data-location="'+a.location+'"data-eventstate="'+a.state+'"><div class="eventItemLayer"><div class="headWrap"><div class="e-image left">'+h+'</div><div class="e-hour e-weak">'+LJ.fn.matchDateHHMM(a.beginsAt)+'</div><div class="e-guests right"><span class="guestsWrap"><span>Ils veulent y aller</span><i class="icon icon-users"></i><span class="nbAskers"> '+a.askersList.length+'</span></span></div></div><div class="askedInWrap">'+l+'</div><div class="bodyWrap"><div class="e-location"><span>'+LJ.fn.matchLocation(a.location)+'</span></div><div class="e-name">'+a.name+' </div><div class="e-desc">'+a.description+"</div>"+j+"</div>"+i+k+"</div></div>";return m},matchTagName:function(a){return"apparte"==a?"appart'":"apero"==a?"apéro":"nuitblanche"==a?"nuit blanche":"firsttime"==a?"première fois":a},matchLocation:function(a){return 1==a?"1er":a+"ème"},matchDateHHMM:function(a){var b="";return 0==a.getHours()&&(b="0"),b+=a.getHours()+"h",a.getMinutes()<10&&(b+="0"),b+=a.getMinutes()},matchDateDDMMYY:function(a){var a=new Date(a),b=a.getDate(),c=a.getMonth()+1+"",d=(a.getFullYear()+"").substring(4,2);return b+"/"+c+"/"+d},renderAskerPlaceholder:function(){var a={id:"placeholder",imgId:LJ.cloudinary.placeholder_id,name:"White",age:25,description:""};return LJ.fn.renderAskerMain(a)},renderAskerMain:function(a,b){b=b||"";var c=LJ.cloudinary.displayParamsAskerMain;c.version=a.imgVersion;var d=$.cloudinary.image(a.imgId,c);d.addClass("zoomable").attr("data-imgid",a.imgId).attr("data-imgversion",a.imgVersion);var e=d.prop("outerHTML"),f=LJ.fn.buildChatId(LJ.user.hostedEventId,LJ.user._id,a._id),g='<div class="chatWrap chat-host none" data-chatid="'+f+'"><div class="chatLineWrap"></div><div class="chatInputWrap"><input type="text" value="" placeholder="Are you alone ?"><input type="submit" value=""></div></div>',h='<div class="a-item '+b+'" data-askerid="'+a._id+'"><div class="a-picture">'+e+'</div><div class="a-birth">Membre depuis le '+LJ.fn.matchDateDDMMYY(a.signupDate)+'</div><div class="a-body"><div class="a-name"><span class="label">Name</span>'+a.name+'</div><div class="a-age"><span class="label">Age</span>'+a.age+' ans</div><div class="a-desc"><span class="label">Style</span><div>'+a.description+'</div></div><div class="a-drink"><span class="label">Drink</span><div class="drink selected">'+a.favoriteDrink+'</div></div></div><div class="a-btn"><button class="themeBtnToggle btn-chat"><i class="icon icon-chat"></i></button></div>'+g+"</div>";return h},renderAskerThumb:function(a){var b=a.asker,c=a.myClass,d=LJ.cloudinary.displayParamsAskerThumb;dbnw=LJ.cloudinary.displayParamsAskerThumbRefused,d.version=b.imgVersion,dbnw.version=b.imgVersion;var e=$.cloudinary.image(b.imgId,dbnw),f=$.cloudinary.image(b.imgId,d);e.addClass("grey"),f.addClass("normal").addClass("none");var g=f.prop("outerHTML"),h=e.prop("outerHTML"),i='<div data-hint="'+b.name+'"data-askerid="'+b._id+'" class="imgWrapThumb hint--top '+c+'"><i class="icon icon-cancel-1 askerRefused none"></i><i class="icon icon-ok-1     askerAccepted none"></i><i class="icon icon-up-dir  none"></i>'+g+h+"</div>";return i},renderAskersThumbs:function(a){for(var b="",c=a||LJ.myAskers.length,d=0;c>d;d++){var e={};d<LJ.myAskers.length?(e.asker=LJ.myAskers[d],e.myClass=0==d?"active":"",b+=LJ.fn.renderAskerThumb(e)):(e.asker={},e.asker._id="placeholder",e.asker.imgId=LJ.cloudinary.placeholder_id,e.myClass="placeholder",b+=LJ.fn.renderAskerThumb(e))}return b},renderOverlayUser:function(a,b){var c=LJ.cloudinary.displayParamsOverlayUser;c.version=b;var d=$.cloudinary.image(a,c).prop("outerHTML");return'<div class="largeThumb">'+d+"</div>"},renderTagsFilters:function(){for(var a="",b=LJ.settings.tagList,c=b.length,d=0;c>d;d++)a+='<div class="tag tag-'+b[d]+'">'+LJ.fn.matchTagName(b[d])+"</div>";return a},renderLocsFilters:function(){for(var a="",b=LJ.locList,c=b.length,d=0;c>d;d++)a+='<div class="loc loc-'+b[d]+'">'+b[d]+"</div>";return a},renderAddFriendToPartyButton:function(a,b){var c="";return"hosting"==a.status?c+='<button class="themeBtn isHosting"><i class="icon icon-forward-1"></i></button>':b?b?c+='<button class="themeBtn onHold"><i class="icon icon-ok-1"></i></button>':void 0:c+='<button class="themeBtn ready"><i class="icon icon-user-add"></i></button>'},renderUser:function(a){var b=a.user,c=a.wrap,d=a.myClass,e="";if(!b||!c)return alert("Cannot format user");if("searchWrap"==c)var f="u",g="<button></button>";if("eventsWrap"==c)var f="f",g='<button class="none"></button>';var h=LJ.cloudinary.displayParamsAskerThumb;imgId=b.imgId,h.version=b.imgVersion,h.radius="5";var i=$.cloudinary.image(imgId,h).prop("outerHTML");return e+='<div class="'+f+"-item "+d+'" data-username="'+b.name.toLowerCase()+'"data-userid="'+b._id+'"data-userdrink="'+b.favoriteDrink.toLowerCase()+'"data-userage="'+b.age+'"><div class="u-head imgWrapThumb">'+i+'</div><div class="'+f+'-body"><span class="'+f+'-name">'+b.name+'</span><span class="'+f+'-age">'+b.age+' ans, drinks</span><span class="'+f+'-favdrink">'+b.favoriteDrink+"</span></div>"+g+"</div>"},renderUsersInSearch:function(){for(var a="",b=0;b<LJ.myUsers.length;b++)LJ.myUsers[b]._id!=LJ.user._id&&(a+=LJ.fn.renderUser({user:LJ.myUsers[b],wrap:"searchWrap",myClass:"none"}));return a},renderUsersInFriendlist:function(){var a="",b=LJ.myFriends,c=b.length;if(0==c)return'<div id="noFriendsYet">You dont have any friends to invite <span>Find your friends</span></div>';for(var d=0;c>d;d++)a+=LJ.fn.renderUserInFriendlist(b[d]);return a+="</div></div>"},renderUserInFriendlist:function(a){return a?"hosting"==a.status?LJ.fn.renderUser({user:a,wrap:"eventsWrap"}):"askedMe"==_.find(LJ.user.friendList,function(b){return b.friendId==a._id}).status?"":LJ.fn.renderUser("askedHim"==_.find(LJ.user.friendList,function(b){return b.friendId==a._id}).status?{user:a,wrap:"eventsWrap"}:{user:a,wrap:"eventsWrap"}):""}}),window.LJ.fn=_.merge(window.LJ.fn||{},{handleDomEvents:function(){LJ.fn.handleDomEvents_Globals(),LJ.fn.handleDomEvents_Landing(),LJ.fn.handleDomEvents_FrontPage(),LJ.fn.handleDomEvents_Navbar(),LJ.fn.handleDomEvents_Profile(),LJ.fn.handleDomEvents_Events(),LJ.fn.handleDomEvents_Create(),LJ.fn.handleDomEvents_Management(),LJ.fn.handleDomEvents_Search(),LJ.fn.handleDomEvents_Contact(),LJ.fn.handleDomEvents_Settings()},handleDomEvents_Globals:function(){LJ.$body.on("click",'.chatInputWrap input[type="submit"]',function(a){a.preventDefault(),a.stopPropagation(),LJ.fn.sendChat($(this))}),LJ.$body.on("click",".overlay-high",function(){LJ.fn.toggleOverlay("high")}),LJ.$body.on("click",".overlay-low",function(){LJ.fn.toastMsg("Relax, things start back at 12:00","info")}),LJ.$body.on("click","img.zoomable",function(){var a=$(this).data("imgid"),b=$(this).data("imgversion")||"";LJ.fn.toggleOverlay("high",LJ.fn.renderOverlayUser(a,b),300)})},handleDomEvents_Landing:function(){$("#landingWrap button").click(function(){$("#landingWrap").velocity("transition.fadeOut",{duration:400,complete:function(){LJ.$signupWrap.velocity("transition.slideUpIn",{duration:1400})}})})},handleDomEvents_FrontPage:function(){LJ.$signupBtn.click(function(a){a.preventDefault(),LJ.fn.signupUser()}),LJ.$loginBtn.click(function(a){a.preventDefault(),LJ.fn.loginUser()}),LJ.$resetBtn.click(function(a){a.preventDefault(),LJ.fn.resetPassword()}),$("#login-fb").click(function(a){a.preventDefault(),console.log("Login in with Facebook"),FB.login(function(a){console.log("Client status is now : "+a.status),"connected"==a.status&&FB.api("/me",function(a){var b=a.id;LJ.fn.loginWithFacebook(b)})},{scope:["public_profile","email"]})})},handleDomEvents_Navbar:function(){LJ.$logout.click(function(){location.reload()}),["#contact","#create","#profile","#events","#management","#search","#settings"].forEach(function(a){$(a).click(function(){if($(a).find("span.bubble").addClass("filtered").text(""),!(LJ.state.animatingContent||$(a).hasClass("menu-item-active")||$(a).hasClass("disabled"))){LJ.state.animatingContent=!0;var b=$(a).data("linkedcontent"),c=$(".menu-item-active").offset().left,d=$(a).offset().left;if(c>d){var e="transition.slideLeftOut";myWayIn="transition.slideRightIn"}else{var e="transition.slideRightOut";myWayIn="transition.slideLeftIn"}$(".menu-item-active").removeClass("menu-item-active").find("span.underlay").velocity({opacity:[0,1],translateY:[-2,0]},{duration:300,complete:function(){$(a).addClass("menu-item-active").find("span.underlay").velocity({opacity:[1,0],translateY:[0,-2]},{duration:300})}}),LJ.fn.displayContent($(b),{myWayOut:e,myWayIn:myWayIn,duration:320})}})})},handleDomEvents_Profile:function(){LJ.$validateBtn.click(LJ.fn.updateProfile),$("#profileWrap .drink").click(function(){$("#profileWrap .drink.modified").removeClass("modified"),$(this).hasClass("selected")||$(this).addClass("modified")}),$("#profileWrap .mood").click(function(){$("#profileWrap .mood.modified").removeClass("modified"),$(this).hasClass("selected")||$(this).addClass("modified")})},handleDomEvents_Events:function(){$("#refreshEventsFilters").click(function(){var a=$(".inserted");if(0!=a.length)return 0==LJ.selectedTags.length?$(".inserted").removeClass("inserted"):void a.each(function(a,b){for(var c=$(b),d=_.find(LJ.myEvents,function(a){return a.hostId==c.attr("data-hostid")}),e=d.tags,f=e.length,g=0;f>g;g++)e[g]="tag-"+e[g];(0!=_.intersection(e,LJ.selectedTags).length||0==LJ.selectedTags.length)&&(c.find(".tag").each(function(a,b){var c=$(b);-1!=LJ.selectedTags.indexOf(c.attr("class").split(" ")[1])&&c.addClass("selected")}),0!=c.find(".tag.selected").length&&c.removeClass("inserted"))})}),LJ.$body.on("click",".f-item button",function(){csl("Asking for someone else");var a=$(this);if(a.hasClass("isHosting")&&(LJ.fn.toastMsg("Redirecting to his event","info"),$(".friendAddIconWrap.active").click()),a.hasClass("ready")){var b=a.parents(".eventItemWrap").attr("data-eventid"),c=a.parents(".eventItemWrap").attr("data-hostid"),d=a.parents(".f-item").attr("data-userid"),e=_.find(LJ.myFriends,function(a){return a._id==d});a.removeClass("ready"),csl("eventId : "+b+"\n hostId : "+c+"\n friend : "+e),LJ.fn.showLoaders(),LJ.fn.requestIn(b,c,e,LJ.user._id)}}),LJ.$body.on("click",".themeBtnToggleHost",function(){$("#management").click()}),LJ.$body.on("click",".chatIconWrap",function(){LJ.fn.toggleChatWrapEvents($(this))}),LJ.$body.on("click",".friendAddIconWrap",function(){return $(".eventItemWrap.surfacing").find(".chatWrap").velocity("transition.slideDownOut",{duration:300}),$(".chatIconWrap.active").removeClass("active"),sleep(30,function(){LJ.state.jspAPI["#friendListWrap"].reinitialise()}),$(this).hasClass("active")?($(this).removeClass("active"),$("#friendListWrap").velocity("transition.slideUpOut",{duration:300}),void LJ.fn.displayAddFriendToPartyButton()):($(".friendAddIconWrap").removeClass("active"),$(this).addClass("active"),$("#friendListWrap").insertAfter($(this).parents(".eventItemWrap").find(".chatWrap")).velocity("transition.slideUpIn",{duration:550}),void LJ.fn.displayAddFriendToPartyButton())}),LJ.$body.on("click",".guestsWrap",function(){$(this).toggleClass("active");var a=$(this).parents(".eventItemWrap").find(".askedInWrap");a.toggleClass("active").velocity($(this).hasClass("active")?"transition.fadeIn":"transition.fadeOut")}),LJ.$body.on("click",".askIn",function(){if(!($(".asking").length>0)){var a=$(this),b=a.parents(".eventItemWrap"),c=a.parents(".eventItemWrap").data("eventid"),d=a.parents(".eventItemWrap").data("hostid");"open"==b.attr("data-eventstate")?(LJ.fn.showLoaders(),a.addClass("asking"),a.hasClass("idle")?LJ.fn.requestIn(c,d,LJ.user,LJ.user._id):LJ.fn.requestOut(c,d,LJ.user,LJ.user._id)):LJ.fn.toastMsg("Event is currently suspended","info")}}),$("#resetFilters").click(function(){LJ.$eventsWrap.find(".selected").removeClass("selected"),$("#activateFilters").click()}),$("#displayFilters").click(function(){var a=$(".filtersWrap");0!=a.css("opacity")?(a.velocity("transition.slideUpOut",{duration:400}),$(this).find("span").text("Afficher")):(a.velocity("transition.slideDownIn",{duration:550}),$(this).find("span").text("Masquer"))}),$("#activateFilters").click(function(){var a=[];locations=[],$(".filters-tags-row .selected").each(function(b,c){var d=$(c).attr("class").split(" ")[1];a.push(d)}),$(".filters-locs-row .selected").each(function(a,b){var c=parseInt($(b).attr("class").split(" ")[1].split("loc-")[1]);locations.push(c)}),LJ.selectedTags=a,LJ.selectedLocations=locations,LJ.fn.filterEvents(LJ.selectedTags,LJ.selectedLocations)}),$("body").on("click","#noFriendsYet span",function(){$("#search").click()})},handleDomEvents_Create:function(){LJ.$createEventBtn.click(function(){LJ.fn.createEvent()})},handleDomEvents_Search:function(){$("#friendsOnly").click(function(){if($(this).hasClass("active"))$(this).removeClass("active").text("Amis uniquement"),$("#searchUsers .u-item").removeClass("filtered"),$("#searchBar input").val("").trigger("keydown");else{$(this).addClass("active").text("Voir tous les utilisateurs"),$("#searchUsers .u-item").each(function(a,b){{var c=_.pluck(LJ.user.friendList,"friendId"),d=$(b).attr("data-userid");c.indexOf(d)}if(-1==c.indexOf(d))$(b).addClass("filtered");else{var e=_.find(LJ.user.friendList,function(a){return a.friendId==d}).status;"mutual"==e&&$(b).addClass("match f-mutual").insertBefore($("#searchUsers .u-item").first()),"askedMe"==e&&(0==$("#searchUsers .u-item.f-mutual").length?$(b).addClass("match f-askedme").insertBefore($("#searchUsers .u-item").first()):$(b).addClass("match f-askedme").insertAfter($("#searchUsers .u-item.f-mutual").last())),"askedHim"==e&&(0==$("#searchUsers .u-item.f-askedme").length?0==$("#searchUsers .u-item.f-mutual").length?$(b).addClass("match f-askedhim").insertBefore($("#searchUsers .u-item").first()):$(b).addClass("match f-askedhim").insertAfter($("#searchUsers .u-item.f-mutual").last()):$(b).addClass("match f-askedhim").insertAfter($("#searchUsers .u-item.f-askedme").last()))}});var a=$("#searchUsers .u-item:not(.filtered)");a.addClass("match").css({opacity:"1"}).removeClass("nonei"),LJ.fn.displayAddUserAsFriendButton()}}),$("#searchBar input").on("keydown",function(){sleep(100,function(){if($("#friendsOnly").hasClass("active")&&0==$("#searchBar input").val().length)return $("#friendsOnly").removeClass("active").trigger("click");$(".u-item").removeClass("match").css({opacity:"0"}).addClass("nonei");var a=$("#searchUsersWrap").find("input").val().toLowerCase();$('.u-item:not(.filtered)[data-username^="'+a+'"], 					   .u-item:not(.filtered)[data-userdrink^="'+a+'"], 					   .u-item:not(.filtered)[data-userage^="'+a+'"]').addClass("match").css({opacity:"1"}).removeClass("nonei").each(function(a,b){for(nextEl=$(".u-item:not(.filtered)").first();nextEl.hasClass("match");)nextEl=nextEl.next();$(b).insertBefore(nextEl)}),LJ.fn.displayAddUserAsFriendButton(),$($(".u-item:not(.match):not(.filtered)")[0]).removeClass("nonei").css({opacity:".5 "}),$($(".u-item:not(.match):not(.filtered)")[1]).removeClass("nonei").css({opacity:".4 "}),$($(".u-item:not(.match):not(.filtered)")[2]).removeClass("nonei").css({opacity:".3 "}),$($(".u-item:not(.match):not(.filtered)")[3]).removeClass("nonei").css({opacity:".15 "})})}),$("#searchUsersWrap").on("click","button",function(){var a=$(this);if(!a.hasClass("onHold")){a.parents(".u-item").addClass("sent");for(var b=LJ.user._id,c=a.parents(".u-item").data("userid"),d=[],e=0;e<LJ.user.eventsAskedList.length;e++)d[e]=$('.eventItemWrap[data-eventid="'+LJ.user.eventsAskedList[e]+'"]').attr("data-hostid");LJ.fn.showLoaders(),LJ.params.socket.emit("friend request in",{userId:b,friendId:c,hostIds:d}),csl("Friending request for : "+c)}})},handleDomEvents_Management:function(){$("#manageEventsWrap i.icon").click(function(){if(!LJ.state.animatingContent){LJ.state.animatingContent=!0;var a="",b=$(".a-item.active");$(this).hasClass("next-right")?($nextItem=b.next(),a=$nextItem.data("askerid")):$(this).hasClass("next-left")&&($nextItem=b.prev(),a=$nextItem.data("askerid")),LJ.fn.displayAskerItem(b,$nextItem,a),$("#askersListWrap .activated").removeClass("activated");var c=parseInt($("#askersThumbs div.active").attr("class").match(/head-\d/)[0][5]);$("#askersListWrap .imgWrapThumb.team-"+c+":not(.active)").addClass("activated")}}),LJ.$body.on("click","#askersListWrap .imgWrapThumb",function(){var a=$(this).data("askerid"),b=$(".a-item.active"),c=$('.a-item[data-askerid="'+a+'"]');$(this).hasClass("next-right")?(c=b.next(),a=c.data("askerid")):$(this).hasClass("next-left")&&(c=b.prev(),a=c.data("askerid")),LJ.fn.displayAskerItem(b,c,a),$("#askersListWrap .activated").removeClass("activated");var d=parseInt($(this).attr("class").match(/head-\d/)[0][5]);$("#askersListWrap .imgWrapThumb.team-"+d+":not(.active)").addClass("activated")}),["#cancelEvent","#suspendEvent"].forEach(function(a){var b=$(a);b.click(function(){var b=LJ.user._id,c=LJ.user.hostedEventId;switch(a){case"#cancelEvent":LJ.fn.cancelEvent(c,b);break;case"#suspendEvent":LJ.fn.suspendEvent(c,b)}})}),LJ.$askersListWrap.on("click",".btn-chat",function(){var a=$(this);a.hasClass("moving")||(a.addClass("moving"),LJ.fn.toggleChatWrapAskers(a),sleep(LJ.ui.artificialDelay,function(){a.removeClass("moving")}))})},handleDomEvents_Contact:function(){$("#sendContactForm").click(function(){var a=LJ.user._id,b=$("#contactName").val(),c=$("#contactMail").val(),d=$("#contactBody").val(),e={userId:a,username:b,email:c,bodytext:d};LJ.fn.showLoaders(),$(this).addClass("validating-btn"),LJ.params.socket.emit("send contact email",e)})},handleDomEvents_Settings:function(){$("#submitSettingsBtn").click(function(){LJ.fn.updateSettings()})}}),window.csl=function(a){console.log(a)},window.LJ.fn=_.merge(window.LJ.fn||{},{init:function(){this.handleDomEvents(),this.initAnimations(),this.initStaticImages(),this.initEhancements(),this.initFacebookState()},initFacebookState:function(){FB.getLoginStatus(function(a){var b=a.status;console.log("Facebook status : "+b),console.log("status : "+b),"connected"==b&&(LJ.fn.toastMsg("Compte Facebook détecté, login in...","info"),sleep(1500,function(){FB.api("/me",function(a){var b=a.id;LJ.fn.loginWithFacebook(b)})}))})},initSocketConnection:function(a){LJ.params.socket=io.connect({query:"token="+a}),LJ.fn.initSocketEventListeners()},initAnimations:function(){$("#bcm_member").click(function(){LJ.fn.displayContent(LJ.$signupWrap,{myWayOut:"transition.slideLeftOut",myWayIn:"transition.slideRightIn",duration:2e3})}),$("#lost_pw").click(function(){LJ.fn.displayContent(LJ.$resetWrap,{myWayOut:"transition.fadeOut",myWayIn:"transition.fadeIn"})}),$("#pw_remember").click(function(){LJ.fn.displayContent(LJ.$loginWrap,{myWayOut:"transition.fadeOut",myWayIn:"transition.fadeIn"})}),LJ.$backToLogin.click(function(){LJ.fn.displayContent(LJ.$loginWrap,{myWayOut:"transition.slideRightOut",myWayIn:"transition.slideLeftIn"})})},initStaticImages:function(){var a=$.cloudinary.image(LJ.cloudinary.loader_id,LJ.cloudinary.displayParamsLoader);a.appendTo($(".loaderWrap")),LJ.cloudinary.displayParamsLoader.width=20;var b=$.cloudinary.image(LJ.cloudinary.m_loader_id,LJ.cloudinary.displayParamsLoader);b.appendTo($(".m-loaderWrap"));var c=$.cloudinary.image(LJ.cloudinary.placeholder_id,LJ.cloudinary.displayParamsPlaceholder);$("#pictureWrap").prepend(c)},initEhancements:function(){!function(){$("#loginWrapp").on("keypress","input.input-field",function(a){"13"==a.which&&(a.preventDefault(),$("#login").click())}),$("#signupWrapp").on("keypress","input.input-field",function(a){"13"==a.which&&(a.preventDefault(),$("#signup").click())}),$(".profileInput, #description").on("change keypress",function(){$(this).addClass("modified")}),LJ.$body.on("click",".themeBtn",function(){$(this).addClass("validating-btn")}),LJ.$body.on("focusout",".askInMsgWrap input",function(){0===$(this).val().trim().length?$(this).removeClass("text-active").val(""):$(this).addClass("text-active")}),LJ.$body.on("mousedown",".chatWrap",function(){var a=$(this);a.find('input[type="text"]').focus()}),LJ.$body.on("keypress",'.chatInputWrap input[type="text"]',function(a){"13"==a.which&&$(this).siblings('input[type="submit"]').click()}),$("body").on("click",".filtersWrap .tag, .filtersWrap .loc, #createEventInputsWrap .tag",function(){$(this).toggleClass("selected")}),$("#createEventWrap .tag").click(function(){return $(this).toggleClass("selected"),$("#createEventWrap .selected").length>3?($(this).toggleClass("selected"),LJ.fn.toastMsg("3 tags maximum","error")):void 0})}()},signupUser:function(a){return a={},a.email=LJ.$emailInputSignup.val(),a.password=LJ.$passwordInputSignup.val(),LJ.$backToLogin.velocity("transition.slideLeftOut",{duration:300}),LJ.fn.showLoaders(),$("input.input-field").addClass("validating"),""===$("#pwSignup").val().trim()||""===$("#pwCheckSignup").val().trim()||""===$("#emailSignup").val().trim()?LJ.fn.handleFailedSignup({msg:"Il manque un champs!"}):$("#pwSignup").val()!=$("#pwCheckSignup").val()?LJ.fn.handleFailedSignup({msg:"Les mots se passe sont différents"}):void $.ajax({method:"POST",url:"/signup",dataType:"json",data:{email:a.email,password:a.password},success:function(b){b.email=a.email,b.password=a.password,LJ.fn.handleSuccessSignup(b)},error:function(a){LJ.fn.handleFailedSignup(a)}})},loginUser:function(a){a=a||{},a.email=a.email||LJ.$emailInput.val(),a.password=a.password||LJ.$passwordInput.val(),$.ajax({method:"POST",url:"/login",dataType:"json",data:{email:a.email,password:a.password},beforeSend:function(){LJ.fn.handleBeforeSendLogin()},success:function(a){LJ.fn.handleSuccessLogin(a)},error:function(a){LJ.fn.handleFailedLogin(a)}})},resetPassword:function(){var a=$("#pwResetInput").val().trim();LJ.fn.showLoaders(),$('#resetWrapp input[type="submit"]').addClass("validating-btn"),$("#pw_remember").velocity("transition.slideRightOut",{duration:300}),$.ajax({method:"POST",url:"/reset",dataType:"json",data:{email:a},success:function(a){LJ.fn.handleSuccessReset(a)},error:function(a){LJ.fn.handleFailedReset(a)}})},updateProfile:function(){var a=LJ.user._id,b=$("#age").val(),c=$("#name").val(),d=$("#description").val(),e=$(".drink.modified").data("drink")||$(".drink.selected").data("drink"),f=$(".mood.modified").data("mood")||$(".mood.selected").data("mood");"new"==LJ.user.status&&(LJ.user.status="idle");var g={_id:a,age:b,name:c,description:d,favoriteDrink:e,mood:f,status:LJ.user.status};csl("Emitting update profile"),LJ.fn.showLoaders(),LJ.params.socket.emit("update profile",g)},updateSettings:function(){var a=$("#currentEmail").val(),b=$("#newPw").val(),c=$("#newPwConf").val(),d=$("#newsletter").is(":checked"),e=LJ.user._id,f={currentEmail:a,newPw:b,newPwConf:c,newsletter:d,userId:e};LJ.fn.showLoaders(),LJ.params.socket.emit("update settings",f)},swapNodes:function(a,b){var c=a.parentNode,d=a.nextSibling===b?a:a.nextSibling;b.parentNode.insertBefore(a,b),c.insertBefore(b,d)},handleBeforeSendLogin:function(){LJ.$loginBtn.val("Loading"),LJ.$loginBtn.addClass("validating-btn"),LJ.fn.showLoaders(),$("#bcm_member").velocity("transition.slideRightOut",{duration:500}),$("#lost_pw").velocity("transition.slideLeftOut",{duration:500}),$("input.input-field").addClass("validating")},loginWithFacebook:function(a){$.ajax({method:"POST",data:{facebookId:a},dataType:"json",url:"/auth/facebook",success:function(a){LJ.fn.handleSuccessLogin(a)},error:function(){}})},handleSuccessLogin:function(a){LJ.user._id=a._id,LJ.fn.initSocketConnection(a.token),LJ.$loginWrap.find(".header-field").addClass("validated")},handleFailedLogin:function(a){csl("handling fail login"),a=JSON.parse(a.responseText),sleep(LJ.ui.artificialDelay,function(){LJ.fn.handleServerError(a.msg),$("#bcm_member").velocity("transition.slideRightIn",{duration:400,display:"inline-block"}),$("#lost_pw").velocity("transition.slideLeftIn",{duration:400,display:"inline-block"}),LJ.$loginBtn.val("Login")})},handleSuccessSignup:function(a){sleep(LJ.ui.artificialDelay,function(){LJ.fn.hideLoaders(),LJ.fn.loginUser(a)})},handleFailedSignup:function(a){a.responseText&&(a=JSON.parse(a.responseText));var b=a.msg;sleep(LJ.ui.artificialDelay,function(){LJ.fn.handleServerError(b),LJ.$backToLogin.velocity("transition.slideRightIn",{duration:400})})},handleSuccessReset:function(a){sleep(LJ.ui.artificialDelay,function(){LJ.fn.hideLoaders(),$("input.input-field").removeClass("validating"),$("#email").val($("#pwResetInput").val()),LJ.fn.displayContent(LJ.$loginWrap),sleep(1e3,function(){LJ.fn.toastMsg(a.msg,"info"),$("#pwResetInput").val(""),$("#pw_remember").velocity("transition.slideRightIn",{duration:400})})})},handleFailedReset:function(a){a.responseText&&(a=JSON.parse(a.responseText));var b=a.msg;sleep(LJ.ui.artificialDelay,function(){LJ.fn.handleServerError(b),$("#pw_remember").velocity("transition.slideRightIn",{duration:400})})},displayViewAsFrozen:function(){$(".eventItemWrap").remove(),LJ.myEvents=[],$(".eventsHeader").velocity("transition.slideUpOut",{duration:400,complete:function(){$("#frozenTimezone").velocity("transition.slideLeftIn",{duration:700})}})},displayViewAsNormal:function(){$(".eventItemWrap").remove(),LJ.myEvents=[],$("#frozenTimezone").velocity("transition.slideRightOut",{duration:400,complete:function(){$(".eventsHeader").velocity("transition.slideUpIn",{duration:700})}})},displayViewAsNew:function(){$("#management").addClass("filtered"),$("#profile").addClass("menu-item-active").find("span").velocity({opacity:[1,0],translateY:[0,-5]}),$("#landingWrap, #signupWrapp").velocity({opacity:[0,1]},{complete:function(){$("#landingWrap, #signupWrapp").addClass("nonei")
}}),LJ.fn.displayContent(LJ.$profileWrap,{myWayIn:"transition.slideDownIn",myWayOut:"transition.slideUpOut"})},displayViewAsIdle:function(){$("#management").addClass("filtered"),$("#events").addClass("menu-item-active").find("span").velocity({opacity:[1,0],translateY:[0,-5]}),$("#landingWrap, #signupWrapp").velocity({opacity:[0,1]},{complete:function(){$("#landingWrap, #signupWrapp").addClass("nonei")}}),LJ.fn.displayContent(LJ.$eventsWrap,{myWayIn:"transition.slideDownIn",myWayOut:"transition.slideUpOut"})},displayViewAsHost:function(){$("#create").addClass("filtered"),$("#management").addClass("menu-item-active").find("span").velocity({opacity:[1,0],translateY:[0,-5]}),$("#landingWrap, #signupWrapp").velocity({opacity:[0,1]},{complete:function(){$("#landingWrap, #signupWrapp").addClass("nonei")}}),LJ.fn.displayContent(LJ.$manageEventsWrap,{myWayIn:"transition.slideDownIn",myWayOut:"transition.slideUpOut"}),LJ.fn.fetchAskers()},displayUserSettings:function(){$("#codebar").text(LJ.user._id),$("#name").val(LJ.user.name),$("#age").val(LJ.user.age),$("#description").val(LJ.user.description),$('.drink[data-drink="'+LJ.user.favoriteDrink+'"]').addClass("selected"),$('.mood[data-mood="'+LJ.user.mood+'"]').addClass("selected"),LJ.fn.replaceMainImage(LJ.user.imgId,LJ.user.imgVersion,LJ.cloudinary.displayParamsProfile),$("#newsletter").prop("checked",LJ.user.newsletter),$("#currentEmail").val(LJ.user.email),"hosting"==LJ.user.state&&$("#suspendEvent").text("this is a bug"),LJ.$thumbWrap.find("h2#thumbName").text(LJ.user.name);var a=LJ.cloudinary.displayParamsHeaderUser;a.version=LJ.user.imgVersion;var b=$.cloudinary.image(LJ.user.imgId,a);b.addClass("left"),LJ.$thumbWrap.find(".imgWrap").html("").append(b)},displayContent:function(a,b){b=b||{};var c=$(".revealed");c.velocity(b.myWayOut||"transition.fadeOut",{duration:b.duration||400,complete:function(){c.removeClass("revealed"),a.addClass("revealed").velocity(b.myWayIn||"transition.fadeIn",{duration:800,display:"block",complete:function(){LJ.state.animatingContent=!1,"new"===LJ.user.status&&LJ.fn.toggleOverlay("high",LJ.tpl.charte)}})}})},toggleChatWrapAskers:function(a){var b=a.parents(".a-item"),c=b.find(".chatWrap"),d=($(".a-active"),$(".surfacing")),e=c.data("id");return d?d.is(b)?void b.removeClass("surfacing").find(".chatWrap").velocity("transition.slideLeftOut",{duration:300}):(d.removeClass("surfacing").find(".chatWrap").velocity("transition.slideLeftOut",{duration:300}),b.addClass("surfacing").find(".chatWrap").velocity("transition.slideLeftIn",{duration:400}),void sleep(30,function(){void 0!==LJ.state.jspAPI[e]&&(LJ.state.jspAPI[e].reinitialise(),LJ.state.jspAPI[e].scrollToBottom())})):void b.addClass("surfacing").find(".chatWrap").velocity("transition.slideLeftIn",{duration:400})},toggleChatWrapEvents:function(a){var b=a.parents(".eventItemWrap"),c=b.find(".chatWrap"),d=($(".prev"),$(".surfacing"));$("#friendListWrap").velocity("transition.slideUpOut",{duration:300}),$(".friendAddIconWrap.active").removeClass("active");var e=c.data("chatid");return d?d.is(b)?(a.removeClass("active"),void b.removeClass("surfacing").find(".chatWrap").velocity("transition.slideUpOut",{duration:300})):($(".chatIconWrap").removeClass("active"),a.addClass("active"),d.removeClass("surfacing").find(".chatWrap").velocity("transition.slideUpOut",{duration:300}),b.addClass("surfacing").find(".chatWrap").velocity("transition.slideUpIn",{duration:550}),void sleep(30,function(){void 0!==LJ.state.jspAPI[e]&&(LJ.state.jspAPI[e].reinitialise(),LJ.state.jspAPI[e].scrollToBottom())})):(a.addClass("active"),void b.addClass("surfacing").find(".chatWrap").velocity("transition.slideUpIn",{duration:550}))},initAppSettings:function(a){var b=a.user,c=a.settings;LJ.user=b,LJ.settings=c},updateClientSettings:function(a){_.keys(a).forEach(function(b){LJ.user[b]=a[b]})},toastMsg:function(a,b,c){var d,e,f;"error"==b&&(d=".toastError",f=LJ.tpl.toastError),"info"==b&&(d=".toastInfo",f=LJ.tpl.toastInfo),"success"==b&&(d=".toastSuccess",f=LJ.tpl.toastSuccess),0===$(".toast").length?($(f).prependTo("#mainWrap"),e=$(d),toastMsg=e.find(".toastMsg"),toastMsg.text(a),e.velocity("transition.slideDownIn",{duration:600,complete:function(){c||e.velocity("transition.slideUpOut",{duration:300,delay:2e3,complete:function(){e.remove()}})}})):(e=$(".toast"),e.finish().velocity("transition.slideUpOut",{duration:200,complete:function(){e.remove(),LJ.fn.toastMsg(a,b)}}))},replaceMainImage:function(a,b,c){c.version=b;var d=$("#pictureWrap").find("img"),e=$.cloudinary.image(a,c);e.addClass("mainPicture").addClass("none"),$("#pictureWrap").prepend(e),d.velocity("transition.fadeOut",{duration:600,complete:function(){e.velocity("transition.fadeIn",{duration:700,complete:function(){}}),d.remove()}})},replaceThumbImage:function(a,b,c){c=c||LJ.cloudinary.displayParamsHeaderUser,c.version=b;var d=$("#thumbWrap").find("img"),e=$.cloudinary.image(a,c);e.hide(),$("#thumbWrap").prepend(e),d.fadeOut(700,function(){$(this).remove(),e.fadeIn(700)})},initCloudinary:function(a){$.cloudinary.config(LJ.cloudinary.uploadParams),LJ.tpl.$placeholderImg=$.cloudinary.image(LJ.cloudinary.placeholder_id,LJ.cloudinary.displayParamsEventAsker),$(".upload_form").html("").append(a),$(".cloudinary-fileupload").bind("fileuploadstart",function(){LJ.fn.showLoaders()}).bind("fileuploadprogress",function(a,b){$(".progress_bar").css("width",Math.round(100*b.loaded/b.total)+"%")}).bind("cloudinarydone",function(a,b){sleep(LJ.ui.artificialDelay,function(){$(".progress_bar").velocity("transition.slideUpOut",{duration:400,complete:function(){$(this).css({width:"0%"}).velocity("transition.slideUpIn")}}),LJ.fn.hideLoaders(),LJ.fn.toastMsg("Votre photo de profile a été modifiée","info");var a=b.result.public_id,c=b.result.version;LJ.user.imgVersion=c,LJ.user.imgId=a,LJ.params.socket.emit("update picture",{_id:LJ.user._id,imgId:a,imgVersion:c}),LJ.fn.replaceMainImage(a,c,LJ.cloudinary.displayParamsProfile),LJ.fn.replaceThumbImage(a,c,LJ.cloudinary.displayParamsHeaderUser)})}).cloudinary_fileupload()},refreshArrowDisplay:function(){var a=$("#manageEventsWrap i.next-left"),b=$("#manageEventsWrap i.next-right");return a.removeClass("none"),b.removeClass("none"),0===$(".a-item").length||1==$(".a-item").length?(a.addClass("none"),void b.addClass("none")):$(".a-item.active").is($(".a-item").last())?void b.addClass("none"):$(".a-item.active").next().hasClass("placeholder")?void b.addClass("none"):$(".a-item.active").is($(".a-item").first())?void a.addClass("none"):void 0},displayAskerItem:function(a,b,c){var d=a.index(),e=b.index(),f=$("#askersThumbs").find('.imgWrapThumb[data-askerid="'+c+'"]');return $(".imgWrapThumb.active").removeClass("active"),f.addClass("active"),LJ.state.animatingContent=!1,e>d?void a.velocity("transition.slideLeftOut",{duration:200,complete:function(){a.removeClass("active"),b.addClass("active"),LJ.fn.refreshArrowDisplay(),b.velocity("transition.slideRightIn",{duration:500,complete:function(){}})}}):d>e?void a.velocity("transition.slideRightOut",{duration:200,complete:function(){a.removeClass("active"),b.addClass("active"),LJ.fn.refreshArrowDisplay(),b.velocity("transition.slideLeftIn",{duration:500,complete:function(){}})}}):void 0},initLayout:function(){$(".tags-wrap").html("").append(LJ.fn.renderTagsFilters()),$(".locs-wrap").html("").append(LJ.fn.renderLocsFilters()),$("#eventsListWrap").html("").append(LJ.tpl.noResult),$("#friendListWrap").jScrollPane(),LJ.state.jspAPI["#friendListWrap"]=$("#friendListWrap").data("jsp"),sleep(LJ.ui.artificialDelay,function(){if(LJ.state.connected)return LJ.fn.toastMsg("Vous avez été reconnecté","success");switch(LJ.state.connected=!0,LJ.fn.toastMsg("Bienvenue "+LJ.user.name,"info"),$("#thumbWrap").velocity("transition.slideUpIn"),$(".menu-item-active").removeClass("menu-item-active"),LJ.user.status){case"new":LJ.params.socket.emit("request welcome email",LJ.user._id),LJ.fn.displayViewAsNew();break;case"idle":LJ.fn.displayViewAsIdle();break;case"hosting":LJ.fn.displayViewAsHost();break;default:alert("No status available, contact us")}sleep(2400,function(){$(".menu-item").velocity({opacity:[1,0]},{display:"inline-block",duration:800,complete:function(){$(".menu-item").each(function(a,b){$(b).append('<span class="bubble filtered"></span>')})}})})})},handleServerSuccess:function(a){LJ.fn.toastMsg(a,"info"),0!=$(".mood.modified").length&&$(".mood.selected").removeClass("selected"),0!=$(".drink.modified").length&&$(".drink.selected").removeClass("selected"),$(".modified").removeClass("modified").addClass("selected"),$(".validating").removeClass("validating"),$(".validating-btn").removeClass("validating-btn"),$(".asking").removeClass("asking"),$(".pending").removeClass("pending"),LJ.fn.hideLoaders()},handleServerError:function(a){LJ.fn.toastMsg(a,"error"),$(".validating").removeClass("validating"),$(".validating-btn").removeClass("validating-btn"),$(".asking").removeClass("asking"),$(".pending").removeClass("pending"),LJ.fn.hideLoaders()},initSocketEventListeners:function(){LJ.params.socket.on("connect",function(){csl("Client authenticated on the socket stream");var a=LJ.user._id;LJ.params.socket.emit("fetch user and configuration",a)}),LJ.params.socket.on("refetch askers success",function(a){csl("Refetch askers success, askers = "+a),LJ.myAskers=a,LJ.fn.addFriendLinks(),$("#askersListWrap div.active").click(),LJ.fn.refreshArrowDisplay()}),LJ.params.socket.on("terminate events",function(){LJ.fn.toastMsg("Les évènements sont maintenant terminés!","info"),LJ.fn.displayViewAsFrozen()}),LJ.params.socket.on("restart events",function(){LJ.fn.toastMsg("Les évènements sont à présent ouverts!","info"),LJ.fn.displayViewAsNormal()}),LJ.params.socket.on("fetch user and configuration success",function(a){LJ.fn.hideLoaders();var b=a.user,c=a.settings;LJ.fn.initAppSettings(a,c),LJ.fn.displayUserSettings(),LJ.fn.initRooms(LJ.user._id),LJ.fn.initCloudinary(b.cloudTag),LJ.fn.initLayout(c),LJ.fn.fetchEvents(),LJ.fn.fetchUsers(),LJ.fn.fetchFriends()}),LJ.params.socket.on("update profile success",function(a){csl("update profile success received"),sleep(LJ.ui.artificialDelay,function(){LJ.fn.updateClientSettings(a),$("#thumbName").text(a.name),LJ.fn.handleServerSuccess("Vos informations ont été modifiées")})}),LJ.params.socket.on("update image success",function(a){LJ.fn.updateClientSettings(a),csl(JSON.stringify(a,0,4))}),LJ.params.socket.on("create event success",function(a){var b=a._id,c=a.hostId;sleep(LJ.ui.artificialDelay,function(){LJ.user._id===c?(LJ.user.status="hosting",LJ.fn.displayMenuStatus(function(){$("#management").click()}),LJ.user.hostedEventId=b,LJ.fn.hideLoaders(),$(".themeBtn").removeClass("validating-btn"),LJ.$createEventWrap.find("input, #eventDescription").val(""),LJ.$createEventWrap.find(".selected").removeClass("selected"),LJ.fn.refreshArrowDisplay()):(LJ.fn.toastMsg(a.hostName+" a créé un évènement !","info"),LJ.fn.bubbleUp("#events")),LJ.fn.insertEvent(a),$("#refreshEventsFilters").click()})}),LJ.params.socket.on("change state event success",function(a){sleep(LJ.ui.artificialDelay,function(){{var b=a.myEvent.state;a.eventId}switch(b){case"canceled":LJ.fn.handleCancelEvent(a);break;case"suspended":LJ.fn.handleSuspendEvent(a,"suspended");break;case"open":LJ.fn.handleSuspendEvent(a,"open");break;default:LJ.fn.toastMsg("Strange thing happend","error")}})}),LJ.params.socket.on("fetch user success",function(a){console.log(a)}),LJ.params.socket.on("friend already in",function(){csl("Friend already in"),sleep(LJ.ui.artificialDelay,function(){LJ.fn.hideLoaders(),LJ.fn.displayAddFriendToPartyButton(),LJ.fn.toastMsg("Votre ami s'est ajouté à lévènement entre temps","info")})}),LJ.params.socket.on("fetch events success",function(a){LJ.state.fetchingEvents=!1;for(var b=a.length,c=0;b>c;c++)LJ.myEvents[c]=a[c],LJ.myEvents[c].createdAt=new Date(a[c].createdAt),LJ.myEvents[c].beginsAt=new Date(a[c].beginsAt);LJ.myEvents.sort(function(a,b){return a.beginsAt-b.beginsAt}),LJ.fn.displayEvents()}),LJ.params.socket.on("request participation in success",function(a){var b=a.hostId,c=a.userId,d=a.eventId,e=a.requesterId,f=a.asker;sleep(LJ.ui.artificialDelay,function(){LJ.fn.bubbleUp("#management");var a=LJ.cloudinary.displayParamsEventAsker;a.version=f.imgVersion;var g=LJ.fn.renderAskerInEvent(f.imgId,{dataList:[{dataName:"askerid",dataValue:f._id}]}),h=$('.eventItemWrap[data-eventid="'+d+'"]').find(".askedInWrap");if(h.prepend(g),LJ.user._id==e&&LJ.user._id==c&&(LJ.fn.hideLoaders(),LJ.fn.toastMsg("Votre demande a été envoyée","info"),$(".asking").removeClass("asking").removeClass("idle").addClass("asked").text("En attente").siblings(".chatIconWrap, .friendAddIconWrap").velocity("transition.fadeIn")),LJ.user._id!=e&&LJ.user._id==c&&(LJ.fn.toastMsg("Un ami vous a ajouté à une soirée","info"),$('.eventItemWrap[data-eventid="'+d+'"]').find(".askIn").removeClass("asking").removeClass("idle").addClass("asked").text("En attente").siblings(".chatIconWrap, .friendAddIconWrap").velocity("transition.fadeIn")),LJ.user._id==e&&LJ.user._id!=c&&(LJ.fn.toastMsg("Votre ami a été ajouté","info"),LJ.fn.hideLoaders(),LJ.fn.displayAddFriendToPartyButton()),LJ.user._id==b){LJ.myAskers.push(f);var i=LJ.fn.renderAskerMain(f),j=LJ.fn.renderAskerThumb({asker:f});$(i).appendTo($("#askersMain")).hide(),$(j).appendTo($("#askersThumbs")),1==$(".a-item").length&&$("#manageEventsWrap .a-item, #manageEventsWrap .imgWrapThumb").addClass("active").velocity("transition.fadeIn",{duration:300,display:"inline-block"}),LJ.fn.refetchAskers(),LJ.fn.refreshArrowDisplay()}var k=$('.eventItemWrap[data-eventid="'+d+'"]').find(".e-guests span.nbAskers");k.text(parseInt(k.text())+1)})}),LJ.params.socket.on("request participation out success",function(a){console.log(a.asker.name+" asked out");var b=a.userId,c=a.hostId,d=a.eventId,e=a.asker,f=a.requesterId,g=LJ.fn.buildChatId(d,c,b),h=LJ.$askersListWrap.find('.a-item[data-askerid="'+b+'"]'),i=(LJ.$askersListWrap.find('.chatWrap[data-chatid="'+g+'"]'),LJ.$eventsListWrap.find('.chatWrap[data-chatid="'+g+'"]'));_.remove(LJ.myAskers,function(b){return b._id===a.userId}),sleep(LJ.ui.artificialDelay,function(){LJ.fn.hideLoaders(),c===LJ.user._id&&($('.imgWrapThumb[data-askerid="'+e._id+'"]').remove(),h.velocity("transition.fadeOut",{duration:200,complete:function(){return h.remove(),h.hasClass("active")?($(".imgWrapThumb").first().addClass("active"),void $(".a-item").first().addClass("active").velocity("transition.fadeIn",{duration:300,complete:function(){LJ.fn.refreshArrowDisplay()}})):LJ.fn.refreshArrowDisplay()}})),f==b&&LJ.user._id==b&&(LJ.fn.toggleChatWrapEvents(i.find(".chatIconWrap")),LJ.fn.toastMsg("Vous avez été désinscris de la liste","info"),$(".asking").removeClass("asked").removeClass("asking").addClass("idle").text("Je veux y aller!").siblings(".chatIconWrap, .friendAddIconWrap").hide());var a=$('.eventItemWrap[data-eventid="'+d+'"]').find(".e-guests span.nbAskers");a.text(parseInt(a.text())-1),$('.eventItemWrap[data-eventid="'+d+'"]').find(".askedInWrap").find('img[data-askerid="'+e._id+'"]').remove()})}),LJ.params.socket.on("accept asker success",function(a){csl("Asker has been accepted");var b=a.eventId,c=a.hostId,d=(a.askerId,$('.eventItemWrap[data-eventid="'+b+'"]').find(".e-guests span.nbAskers"));d.text(parseInt(d.text())+1),c=LJ.user._id}),LJ.params.socket.on("update settings success",function(a){sleep(LJ.ui.artificialDelay,function(){LJ.fn.toastMsg(a.msg,"info"),$(".validating-btn").removeClass("validating-btn"),LJ.fn.hideLoaders()})}),LJ.params.socket.on("send contact email success",function(){sleep(LJ.ui.artificialDelay,function(){LJ.fn.toastMsg("Merci beaucoup!","info"),$(".validating-btn").removeClass("validating-btn"),LJ.fn.hideLoaders()})}),LJ.params.socket.on("server error",function(a){var b=a.msg,c=a.flash;return csl("Receiving error from the server"),c?LJ.fn.handleServerError(b):void sleep(LJ.ui.artificialDelay,function(){LJ.fn.handleServerError(b)})}),LJ.params.socket.on("disconnect",function(){LJ.fn.toastMsg("Quelque chose s'est produit, vous avez été déconnecté","error",!0),LJ.params.socket.disconnect(LJ.user._id)}),LJ.params.socket.on("fetch askers success",function(a){LJ.state.fetchingAskers=!1,LJ.myAskers=a.askersList,LJ.fn.displayAskers(),LJ.fn.refetchAskers()}),LJ.params.socket.on("receive message",function(a){LJ.fn.addChatLine(a)}),LJ.params.socket.on("fetch friends success",function(a){csl("Friends fetched"),LJ.myFriends=a,$("#myFriends").html(LJ.fn.renderUsersInFriendlist()),LJ.fn.displayAddFriendToPartyButton(),"fetch friends"==LJ.nextCallback.context&&(csl("Calling method, context detected"),LJ.nextCallback.fn(),LJ.nextCallback={})}),LJ.params.socket.on("fetch users success",function(a){csl("Users fetched"),LJ.myUsers=_.shuffle(a),$("#searchUsers").html(LJ.fn.renderUsersInSearch()),$($(".u-item:not(.match)")[0]).removeClass("none").css({opacity:".5 "}),$($(".u-item:not(.match)")[1]).removeClass("none").css({opacity:".4 "}),$($(".u-item:not(.match)")[2]).removeClass("none").css({opacity:".3 "}),$($(".u-item:not(.match)")[3]).removeClass("none").css({opacity:".15 "})}),LJ.params.socket.on("friend request in success host",function(a){var b=a.userId,c=a.friendId;if(0!=LJ.myAskers.length){var d=_.pluck(LJ.myAskers,"_id");-1!=d.indexOf(b)&&-1!=d.indexOf(c)&&LJ.fn.refetchAskers()}}),LJ.params.socket.on("friend request in success",function(a){{var b=a.userId,c=a.friendId,d=a.updateType;a.friendList}if(0!=LJ.myAskers.length){var e=_.pluck(LJ.myAskers,"_id");-1!=e.indexOf(b)&&-1!=e.indexOf(c)&&LJ.fn.refetchAskers()}LJ.user.friendList=a.friendList,LJ.nextCallback.context="fetch friends",LJ.nextCallback.fn=function(){csl("Calling function"),sleep(LJ.ui.artificialDelay,function(){return LJ.fn.displayAddUserAsFriendButton(),"askedhim"==d?void LJ.fn.handleServerSuccess("Votre demande a été envoyée"):"askedme"==d?(LJ.fn.handleServerSuccess("Vous avez une demande d'ami"),void LJ.fn.bubbleUp("#search")):"mutual"==d&&b==LJ.user._id?void LJ.fn.handleServerSuccess("Vous êtes à présent amis"):"mutual"==d&&c==LJ.user._id?(LJ.fn.handleServerSuccess("Votre demande a été acceptée!"),void LJ.fn.bubbleUp("#search")):void 0})},LJ.fn.fetchFriends()})},handleCancelEvent:function(a){a.hostId==LJ.user._id&&($(".pending").removeClass("pending"),LJ.user.status="idle",LJ.myAskers=[],LJ.$manageEventsWrap.find("#askersThumbs, #askersMain").html(""),LJ.fn.displayMenuStatus(function(){$("#create").click()}));var b=LJ.$eventsListWrap.find('.eventItemWrap[data-hostid="'+a.hostId+'"]');b.velocity("transition.slideRightOut",{complete:function(){b.remove()}}),_.remove(LJ.myEvents,function(b){return b.hostId==a.hostId})},handleSuspendEvent:function(a,b){var c=a.eventId;if(a.hostId==LJ.user._id){var d=$("#suspendEvent");$(".pending").removeClass("pending"),"suspended"==a.myEvent.state&&(LJ.fn.toastMsg("Les inscriptions sont momentanément suspendues","info"),d.text("Reprendre")),"open"==a.myEvent.state&&(LJ.fn.toastMsg("Les inscriptions sont à nouveau possible","info"),d.text("Suspendre"))}var e=LJ.$eventsWrap.find('.eventItemWrap[data-eventid="'+c+'"]');e.attr("data-eventstate",b).find("button.askIn")},insertEvent:function(a){csl("Inserting new event"),a.beginsAt=new Date(a.beginsAt);var b=_.sortedIndex(LJ.myEvents,a,"beginsAt");LJ.myEvents.splice(b,0,a);var c=LJ.fn.renderEvent(a);0==b&&($(c).insertAfter($("#noEvents")),$("#noEvents").addClass("none")),b==LJ.myEvents.length-1?$(c).insertAfter($($(".eventItemWrap")[b-1])).addClass("inserted"):$(c).insertAfter($($(".eventItemWrap")[b])).addClass("inserted")},fetchUsers:function(){LJ.params.socket.emit("fetch users",LJ.user._id)},fetchFriends:function(){LJ.params.socket.emit("fetch friends",LJ.user._id)},createEvent:function(){var a=[];$("#createEventWrap .selected").each(function(b,c){var d=$(c).attr("class").split(" ")[1].split("-")[1];a.push(d)});var b={};b.hostId=LJ.user._id,b.hostName=LJ.user.name,b.hostImgId=LJ.user.imgId,b.hostImgVersion=LJ.user.imgVersion,b.name=$("#eventName").val(),b.location=$("#eventLocation").val(),b.hour=$("#eventHour").val(),b.min=$("#eventMinut").val(),b.description=$("#eventDescription").val(),b.maxGuest=$("#eventMaxGuest").val(),b.tags=a,LJ.fn.showLoaders(),LJ.params.socket.emit("create event",b)},fetchEvents:function(){LJ.state.fetchingEvents?LJ.fn.toastMsg("Already fetching events","error"):(LJ.state.fetchingEvents=!0,LJ.params.socket.emit("fetch events",LJ.user._id))},fetchAskers:function(){LJ.state.fetchingAskers?LJ.fn.toastMsg("Already fetching askers","error"):(LJ.state.fetchingAskers=!0,LJ.params.socket.emit("fetch askers",{eventId:LJ.user.hostedEventId,hostId:LJ.user._id}))},displayEvents:function(){var a=(new Date).getHours();return a<LJ.settings.eventsRestartAt&&a>=LJ.settings.eventsTerminateAt?(csl("Displaying events frozen state"),LJ.fn.displayViewAsFrozen()):(LJ.$eventsListWrap.html(LJ.fn.renderEvents(LJ.myEvents)),void $(".eventItemWrap").velocity("transition.slideLeftIn",{display:"inline-block"}))},displayAskers:function(){$("#askersMain").html("").append(LJ.fn.renderAskersMain()),$("#askersThumbs").html("").append(LJ.fn.renderAskersThumbs()),LJ.fn.refreshArrowDisplay()},refetchAskers:function(){var a=_.pluck(LJ.myAskers,"_id");LJ.params.socket.emit("refetch askers",{userId:LJ.user._id,idArray:a})},addFriendLinks:function(){for(var a=_.pluck(LJ.myAskers,"_id"),b=0;b<LJ.myAskers.length;b++){$("#askersThumbs .team-"+b).removeClass("team-"+b),$("#askersThumbs .head-"+b).removeClass("head-"+b),console.log("Browsing for : "+LJ.myAskers[b].name),$('#askersThumbs div[data-askerid="'+LJ.myAskers[b]._id+'"]').addClass("team-"+b).addClass("head-"+b);for(var c=0;c<LJ.myAskers[b].friendList.length;c++)-1==a.indexOf(LJ.myAskers[b].friendList[c].friendId)?console.log("Friend n° : "+c+"  "+LJ.myAskers[b].friendList[c].name+" is not in the event"):(console.log(LJ.myAskers[b].friendList[c].name+" is in the event, status : "+LJ.myAskers[b].friendList[c].status),"mutual"==LJ.myAskers[b].friendList[c].status&&(console.log("Adding link team-"+b+" , for  "+LJ.myAskers[b].friendList[c].name),$('#askersThumbs div[data-askerid="'+LJ.myAskers[b].friendList[c].friendId+'"]').addClass("team-"+b)))}},filterEvents:function(a,b){LJ.$eventsListWrap.find(".selected").removeClass("selected"),isFilteredByLoc=0!=b.length,isFilteredByTag=0!=a.length;var c=[],d=!1,e=!1;$(".eventItemWrap").each(function(f,g){function h(){c.push($(g))}d=e=!1,-1!=b.indexOf($(g).data("location"))&&(d=!0),$(g).find(".tag").each(function(b,c){var d=$(c).prop("class").split(" ")[1];-1!=a.indexOf(d)&&($(c).addClass("selected"),e=!0)}),isFilteredByTag||isFilteredByLoc||h(),isFilteredByTag&&isFilteredByLoc&&e&&d&&h(),isFilteredByTag&&!isFilteredByLoc&&e&&h(),!isFilteredByTag&&isFilteredByLoc&&d&&h()}),console.log("Events to display : "+c),LJ.$eventsToDisplay=$(c).map(function(){return this.toArray()}),$(".eventItemWrap, #noEvents ").addClass("filtered"),LJ.$eventsToDisplay.removeClass("filtered"),0==LJ.$eventsToDisplay.length?(LJ.fn.toastMsg("Aucun évènement trouvés","info"),$("#noEvents").removeClass("filtered").addClass("none").velocity("transition.slideLeftIn",{duration:700})):LJ.fn.toastMsg(LJ.$eventsToDisplay.length+" soirées pour ces filtres!","info")},requestIn:function(a,b,c,d){csl("requesting IN with id : "+a),LJ.params.socket.emit("request participation in",{userInfos:c,hostId:b,eventId:a,requesterId:d})},requestOut:function(a,b,c,d){csl("requesting OUT with id : "+a),LJ.params.socket.emit("request participation out",{userInfos:LJ.user,hostId:b,eventId:a,requesterId:d})},sendChat:function(a){var b=a.siblings('input[type="text"]'),c=b.val();b.val("");var d=a.parents(".a-item").data("askerid")||LJ.user._id,e=a.parents(".eventItemWrap").data("hostid")||LJ.user._id,f=a.parents(".eventItemWrap").data("eventid")||LJ.user.hostedEventId;csl("Sending chat with id : "+f+" and "+e+" and "+d),LJ.params.socket.emit("send message",{msg:c,eventId:f,hostId:e,askerId:d,senderId:LJ.user._id})},bubbleUp:function(a){var b=$(a),c=b.find(".bubble"),d=0==c.text()?0:parseInt(c.text());return c.removeClass("filtered"),c.text(99==d?d+"+":d+1)},displayAddUserAsFriendButton:function(){var a=$("#searchUsers .u-item.match");a.each(function(a,b){var c,d=$(b),e=d.attr("data-userid");-1!=_.pluck(LJ.user.friendList,"friendId").indexOf(e)?("mutual"==_.find(LJ.user.friendList,function(a){return a.friendId==e}).status&&(c='<button class="themeBtn onHold"><i class="icon icon-ok-1"></i></button>'),"askedMe"==_.find(LJ.user.friendList,function(a){return a.friendId==e}).status&&(c='<button class="themeBtn"><i class="icon icon-ellipsis"></i></button>'),"askedHim"==_.find(LJ.user.friendList,function(a){return a.friendId==e}).status&&(c='<button class="themeBtn onHold"><i class="icon icon-ellipsis"></i></button>')):c='<button class="themeBtn"><i class="icon icon-user-add"></i></button>',d.find("button").replaceWith(c)})},displayAddFriendToPartyButton:function(){var a=$("#friendListWrap"),b=(a.parents(".eventItemWrap"),a.parents(".eventItemWrap").find(".askedInWrap"));a.find(".f-item").each(function(a,c){var d,e=$(c),f=e.data("userid"),g=_.find(LJ.myFriends,function(a){return a._id==f});return"hosting"==g.status?(d='<button class="themeBtn isHosting"><i class="icon icon-forward-1"></i></button>',e.find("button").replaceWith(d)):1==b.find('img[data-askerid="'+f+'"]').length?(d='<button class="themeBtn onHold"><i class="icon icon-ok-1"></i></button>',e.find("button").replaceWith(d)):(d='<button class="themeBtn ready"><i class="icon icon-user-add"></i></button>',e.find("button").replaceWith(d))})},buildChatId:function(a,b,c){return a+"_"+b+"-"+c},addChatLine:function(a){csl("Adding chatline");var b;a.senderId===LJ.user._id?ha="cha-user":b="cha-other";var c='<div class="chatLine none"><div class="cha '+b+'">'+a.msg+"</div></div>",d=a.chatId,e=$('.chatWrap[data-chatid="'+d+'"]').find(".chatLineWrap");e.hasClass("jspScrollable")||(csl("Turning chatLineWrap scrollable"),e.jScrollPane(),LJ.state.jspAPI[d]=e.data("jsp")),e.find(".jspPane").append(c),e.find(".chatLine:last-child").velocity("fadeIn",{duration:350,complete:function(){}}),sleep(60,function(){csl("Refreshing jsp API"),LJ.state.jspAPI[d].reinitialise(),LJ.state.jspAPI[d].scrollToBottom()})},initRooms:function(a){LJ.params.socket.emit("load rooms",a)},cancelEvent:function(a,b){csl("canceling event : "+a+"  with hostId : "+b),LJ.params.socket.emit("cancel event",{eventId:a,hostId:b}),$("#cancelEvent").addClass("pending")},suspendEvent:function(a,b){LJ.params.socket.emit("suspend event",{eventId:a,hostId:b}),$("#suspendEvent").addClass("pending")},showLoaders:function(){$(".loaderWrap, .m-loaderWrap").velocity("fadeIn",{duration:400})},hideLoaders:function(){$(".loaderWrap, .m-loaderWrap").velocity("fadeOut",{duration:250})},displayMenuStatus:function(a){var b=LJ.user.status;"idle"==b&&$("#management").velocity("transition.slideRightOut",{duration:200,complete:function(){$("#create").removeClass("filtered").velocity("transition.slideLeftIn",{duration:200,display:"inline-block",complete:function(){a()}})}}),"hosting"==b&&$("#create").velocity("transition.slideRightOut",{duration:200,complete:function(){$("#management").removeClass("filtered").velocity("transition.slideLeftIn",{duration:200,display:"inline-block",complete:function(){a()}})}})},toggleOverlay:function(a,b,c){var d=$(".overlay-"+a);d.append(b),d.hasClass("active")?d.removeClass("active").velocity("fadeOut",{duration:c||700,complete:function(){d.find(".largeThumb").remove()}}):d.addClass("active").velocity("fadeIn",{duration:700})}}),$("document").ready(function(){sleep(1e3,function(){FB.init({appId:"1509405206012202",xfbml:!0,version:"v2.1"}),csl("Application ready"),LJ.fn.init()})});